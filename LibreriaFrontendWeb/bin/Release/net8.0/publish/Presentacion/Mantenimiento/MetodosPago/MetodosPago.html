<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuración de Metodos de Pago</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.1/dist/sweetalert2.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <link rel="stylesheet" href="/Comun/css/temaOscuro.css">
    <style>
        .form-group {
            margin-bottom: 15px;
        }

        .table-responsive {
            overflow-x: auto;
        }

        .btn-guardar {
            font-size: 1.2rem;
            padding: 8px 25px;
        }

        .porcentaje-input {
            max-width: 120px;
        }

        .payment-row {
            transition: background-color 0.3s;
        }

            .payment-row:hover {
                background-color: rgba(0, 123, 255, 0.05);
            }

        .alert-info {
            border-left: 4px solid #0dcaf0;
            background-color: rgba(13, 202, 240, 0.1);
        }

        .preview-content {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }

        /* Estilos para el tema oscuro en SweetAlert */
        .dark-theme .swal2-popup {
            background-color: var(--bs-body-bg) !important;
            color: var(--bs-body-color) !important;
        }

        .dark-theme .swal2-title {
            color: var(--bs-heading-color) !important;
        }

        .dark-theme .preview-content {
            background-color: var(--bs-secondary-bg) !important;
            color: var(--bs-body-color) !important;
            border: 1px solid var(--bs-border-color);
        }

            .dark-theme .preview-content strong {
                color: var(--bs-emphasis-color) !important;
            }

        .dark-theme .text-primary {
            color: var(--bs-primary-text-emphasis) !important;
        }
    </style>
</head>
<body>

    <div id="navbar-container"></div>

    <div class="container mt-4">
        <h1><i class="bi bi-credit-card"></i> Configuración de Métodos de Pago</h1>

        <!-- Main Configuration Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h3>Gestión de Porcentajes de Recargo</h3>
                <p class="mb-0 text-muted">Acá podés configurar el porcentaje de recargo que se aplicará a cada método de pago</p>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="tablaMetodosPago">
                        <thead class="table-dark">
                            <tr>
                                <th><i class="bi bi-credit-card me-1"></i>Método de Pago</th>
                                <th><i class="bi bi-percent me-1"></i>Porcentaje de Recargo (%)</th>
                                <th class="me-1">Seña Mínima (%)</th>
                                <th><i class="bi bi-eye me-1"></i>Vista Previa</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyMetodosPago">
                            <!-- Acá se cargan los métodos de pago -->
                        </tbody>
                    </table>
                </div>

                <div class="row mt-4">
                    <div class="col-md-12">
                        <button type="button" class="btn btn-success btn-guardar me-2" id="btnGuardarCambios">
                            <i class="bi bi-floppy"></i> Guardar Cambios
                        </button>
                        <button type="button" class="btn btn-secondary" id="btnCancelar">
                            <i class="bi bi-arrow-clockwise"></i> Cancelar / Recargar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Información Adicional -->
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-info-circle"></i> Información Importante</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info" role="alert">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="bi bi-calculator"></i> ¿Cómo se calcula?</h6>
                            <p class="mb-2">El porcentaje de recargo se aplica sobre el precio de contado del libro.</p>
                            <p class="mb-0"><strong>Fórmula:</strong> Precio Final = Precio Contado + (Precio Contado × Porcentaje ÷ 100)</p>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="bi bi-lightbulb"></i> Ejemplo Práctico</h6>
                            <p class="mb-2">Si un libro cuesta <strong>$1000</strong> de contado y el recargo es <strong>15%</strong>:</p>
                            <p class="mb-0">Precio Final = $1000 + ($1000 × 15 ÷ 100) = <strong>$1150</strong></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.0/signalr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.1/dist/sweetalert2.all.min.js"></script>
    <script src="/Comun/js/comun.js"></script>
    <script src="/Comun/js/tema.js"></script>

    <script>
        $(document).ready(async function () {
            console.log("MetodosPago.html loaded");

            // Verifico que la sesión esté establecida igual que en ModificacionUsuarios
            let sessionReady = false;
            let attempts = 0;
            const maxAttempts = 10;

            while (!sessionReady && attempts < maxAttempts) {
                try {
                    console.log(`Session check attempt ${attempts + 1}`);

                    const sessionCheck = await $.ajax({
                        url: "/api/Usuario/CheckSession",
                        type: "GET",
                        dataType: "json"
                    });

                    console.log("Session check result:", sessionCheck);

                    if (sessionCheck === true) {
                        sessionReady = true;
                        console.log("Session is ready!");
                    } else {
                        console.log("Session not ready, redirecting to login");
                        window.location.href = "/Login/Login.html";
                        return;
                    }
                } catch (error) {
                    console.log("Session check failed, attempt:", attempts + 1, error);
                    attempts++;
                    if (attempts >= maxAttempts) {
                        console.log("Max attempts reached, redirecting to login");
                        window.location.href = "/Login/Login.html";
                        return;
                    }
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }

            // Si llegué acá, la sesión está lista
            console.log("Session verified, initializing page...");

            try {
                await inicializarPagina();
            } catch (error) {
                console.error("Error initializing page:", error);
                toastError("Error al inicializar la página", "Error");
            }

            async function inicializarPagina() {
                console.log("Starting page initialization...");

                // Cargo navbar si no está cargado
                if ($('#navbar-container').is(':empty')) {
                    await new Promise((resolve) => {
                        $('#navbar-container').load('/Nav/Navbar.html', function () {
                            resolve();
                        });
                    });
                }

                // Verifico permisos de admin (igual que en ModificacionUsuarios)
                const isAdmin = await verificarPermisoAdmin();
                if (!isAdmin) {
                    toastError("No tiene permisos para acceder a esta página", "Acceso Denegado");
                    setTimeout(() => {
                        window.location.href = "/Inicio/Inicio.html";
                    }, 2000);
                    return;
                }

                console.log("Admin permissions verified, loading data...");

                // Cargo los métodos de pago
                await cargarMetodosPago();
                configurarEventos();
            }

            async function verificarPermisoAdmin() {
                try {
                    const response = await $.ajax({
                        url: "/api/Usuario/CheckAdminRole",
                        type: "GET",
                        dataType: "json"
                    });
                    return response === true;
                } catch (error) {
                    console.error("Error verificando permisos de admin:", error);
                    return false;
                }
            }

            async function cargarMetodosPago() {
                try {
                    console.log("Loading payment methods...");

                    const response = await $.ajax({
                        url: "/api/Cliente/TraerFormasPago",
                        type: "GET"
                    });

                    console.log("Payment methods response:", response);

                    if (response && response.length > 0) {
                        const tbody = $('#tbodyMetodosPago');
                        tbody.empty();

                        response.forEach(metodo => {
                            const porcentaje = metodo.porcentajeRecargo || 0;
                            const iconoMetodo = obtenerIconoMetodo(metodo.formaPago);

                            const row = `
                                    <tr class="payment-row" data-id="${metodo.id}">
                                        <td>
                                            <i class="${iconoMetodo} me-2"></i>
                                            <strong>${metodo.formaPago}</strong>
                                        </td>
                                        <td>
                                            <div class="input-group porcentaje-input">
                                                <input type="text" class="form-control text-center porcentaje-input-field"
                                                       value="${porcentaje}"
                                                       data-id="${metodo.id}"
                                                       placeholder="0.00">
                                                <span class="input-group-text">%</span>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="input-group porcentaje-input">
                                                <input type="text" class="form-control text-center senia-minima-input-field"
                                                       value="${metodo.seniaMinima || '0'}"
                                                       data-id="${metodo.id}"
                                                       placeholder="0.00">
                                                <span class="input-group-text">%</span>
                                            </div>
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-outline-info btn-preview"
                                                    data-id="${metodo.id}" data-nombre="${metodo.formaPago}">
                                                <i class="bi bi-eye"></i> Ver Ejemplo
                                            </button>
                                        </td>
                                    </tr>
                                `;
                            tbody.append(row);
                        });

                        // Configuramos la validación para los inputs de porcentaje
                        configurarValidacionPorcentajes();

                        console.log("Payment methods loaded successfully");
                    } else {
                        console.log("No payment methods found");
                        toastError('No se pudieron cargar los métodos de pago', 'Error');
                    }
                } catch (error) {
                    console.error('Error cargando métodos de pago:', error);
                    toastError('Error al cargar los métodos de pago', 'Error');
                }
            }

            function obtenerIconoMetodo(formaPago) {
                // Aca asigno iconos especificos segun el metodo de pago
                const iconos = {
                    'Efectivo': 'bi-cash-coin',
                    'Débito': 'bi-credit-card',
                    'Crédito': 'bi-credit-card-2-front',
                    'Transferencia': 'bi-bank'
                };
                return iconos[formaPago] || 'bi-credit-card';
            }

            function configurarValidacionPorcentajes() {
                // Acá uso la función de validación de comun.js
                $('.porcentaje-input-field').on('input', function () {
                    const valor = $(this).val();
                    const validacion = validarPorcentaje(valor);

                    if (validacion.cleanValue !== valor) {
                        $(this).val(validacion.cleanValue);
                    }
                });

                // Acá configuramos la validación para inputs de seña mínima
                $(document).on('input', '.senia-minima-input-field', function () {
                    const originalValue = $(this).val();
                    const validation = validarPorcentaje(originalValue);

                    if (validation.cleanValue !== originalValue) {
                        $(this).val(validation.cleanValue);
                    }
                });
            }

            function configurarEventos() {
                // Evento para guardar cambios
                $('#btnGuardarCambios').click(async function () {
                    await guardarCambios();
                });

                // Evento para cancelar/recargar
                $('#btnCancelar').click(function () {
                    location.reload();
                });

                // Evento para vista previa
                $(document).on('click', '.btn-preview', function () {
                    const metodoPago = $(this).data('nombre');
                    const porcentaje = $(this).closest('tr').find('.porcentaje-input-field').val();
                    const seniaMinima = $(this).closest('tr').find('.senia-minima-input-field').val();
                    mostrarVistaPrevia(metodoPago, porcentaje, seniaMinima);
                });
            }

            async function guardarCambios() {
                try {
                    const metodosPago = [];
                    let hayErrores = false;

                    $('#tbodyMetodosPago tr').each(function () {
                        const id = $(this).data('id');
                        const porcentaje = $(this).find('.porcentaje-input-field').val();
                        const nombreMetodo = $(this).find('td:first strong').text();

                        // Aca validamos que el porcentaje sea valido
                        const validacion = validarPorcentaje(porcentaje || '0');

                        if (!validacion.isValid) {
                            toastError(`El porcentaje para ${nombreMetodo} no es válido`, 'Error de Validación');
                            hayErrores = true;
                            return false;
                        }
                        const seniaMinima = $(this).find('.senia-minima-input-field').val();

                        // Acá validamos que la seña mínima sea válida
                        const validacionSenia = validarPorcentaje(seniaMinima || '0');

                        if (!validacionSenia.isValid) {
                            toastError(`La seña mínima para ${nombreMetodo} no es válida`, 'Error de Validación');
                            hayErrores = true;
                            return false;
                        }

                        metodosPago.push({
                            id: id,
                            porcentajeRecargo: validacion.numericValue || 0,
                            seniaMinima: validacionSenia.numericValue || 0
                        });
                    });

                    if (hayErrores) {
                        return;
                    }

                    if (metodosPago.length === 0) {
                        toastError('No hay datos para guardar', 'Error');
                        return;
                    }

                    const result = await Swal.fire({
                        title: '¿Confirmar cambios?',
                        text: 'Se actualizarán los porcentajes de recargo para todos los métodos de pago',
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonColor: '#0d6efd',
                        cancelButtonColor: '#6c757d',
                        confirmButtonText: 'Sí, guardar',
                        cancelButtonText: 'Cancelar'
                    });

                    if (result.isConfirmed) {
                        console.log("Sending payment methods update:", metodosPago);

                        const response = await $.ajax({
                            url: "/api/Cliente/ActualizarPorcentajesFormasPago",
                            type: "PUT",
                            contentType: "application/json",
                            data: JSON.stringify(metodosPago)
                        });

                        console.log("Update response:", response);

                        if (response === 1) {
                            toastExito('Porcentajes actualizados correctamente', 'Cambios Guardados');
                            await cargarMetodosPago(); // Recargamos la tabla
                        } else {
                            toastError('Error al guardar los cambios', 'Error');
                        }
                    }
                } catch (error) {
                    console.error('Error guardando cambios:', error);
                    toastError('Error al guardar los cambios', 'Error');
                }
            }

            function mostrarVistaPrevia(metodoPago, porcentaje, seniaMinima) {
                const porcentajeNum = parseFloat(porcentaje || 0);
                const seniaMinimaNum = parseFloat(seniaMinima || 0);
                const precioEjemplo = 1000; // Precio base para el ejemplo
                const recargo = precioEjemplo * porcentajeNum / 100;
                const precioFinal = precioEjemplo + recargo;

                // Detectar si estamos en tema oscuro
                const isDarkTheme = document.documentElement.classList.contains('dark-theme');
                const previewClass = isDarkTheme ? 'preview-content dark-theme-preview' : 'preview-content';

                Swal.fire({
                    title: `Vista Previa - ${metodoPago}`,
                    html: `
                            <div class="${previewClass} text-start">
                                <div class="row mb-2">
                                    <div class="col-sm-6"><strong>Precio de contado:</strong></div>
                                    <div class="col-sm-6">${precioEjemplo.toFixed(2)}</div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-sm-6"><strong>Recargo (${porcentajeNum}%):</strong></div>
                                    <div class="col-sm-6">${recargo.toFixed(2)}</div>
                                </div>
                                <hr>
                                <div class="row mb-2">
                                    <div class="col-sm-6"><strong>Seña Mínima:</strong></div>
                                    <div class="col-sm-6"><strong class="text-primary">${(precioFinal*(seniaMinima/100)).toFixed(2)}</strong></div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-sm-6"><strong>Precio final:</strong></div>
                                    <div class="col-sm-6"><strong class="text-primary">${precioFinal.toFixed(2)}</strong></div>
                                </div>
                            </div>
                        `,
                    icon: 'info',
                    confirmButtonText: 'Entendido',
                    confirmButtonColor: '#0d6efd',
                    customClass: {
                        popup: isDarkTheme ? 'dark-theme' : '',
                        htmlContainer: isDarkTheme ? 'dark-theme' : ''
                    }
                });
            }

            // Función para validar porcentajes (acá uso la que está en comun.js)
            function validarPorcentaje(porcentajeOriginal) {
                // Detectar si hay caracteres inválidos
                const contieneCaracteresInvalidos = /[^0-9.,]/.test(porcentajeOriginal);

                // Limpiar el valor dejando solo números y los separadores
                let limpio = porcentajeOriginal.replace(/[^0-9.,]/g, "");

                // Solo permitir un separador decimal
                const partes = limpio.split(/[,\.]/);
                if (partes.length > 2) {
                    limpio = partes[0] + "," + partes[1];
                }

                // Mostrar alerta solo si hubo caracteres inválidos
                if (contieneCaracteresInvalidos && porcentajeOriginal !== '') {
                    toastTopDerecha('El porcentaje debe contener solo números y/o decimales.', "Sólo números");
                }

                // Unificamos el separador como coma
                limpio = limpio.replace('.', ',');

                // Si el resultado está vacío, devolver 0
                if (limpio.trim() === "") {
                    return { isValid: true, cleanValue: '0', numericValue: 0 };
                }

                // Obtener valor numérico
                const numericValue = parseFloat(limpio.replace(',', '.'));

                // Validar que no sea mayor a 100%
                if (numericValue > 100) {
                    toastTopDerecha('El porcentaje no puede ser mayor a 100%', "Porcentaje inválido");
                    return { isValid: false, cleanValue: '100', numericValue: 100 };
                }

                return {
                    isValid: !isNaN(numericValue),
                    cleanValue: limpio,
                    numericValue: isNaN(numericValue) ? 0 : numericValue
                };
            }
        });
    </script>
</body>
</html>